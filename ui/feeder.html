<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1.0, user-scalable=no">
    <title>PLOD viewer</title>
    <!--link rel="shortcut icon" type="images/ico" href="http://www.datatables.net/favicon.ico"-->

    <!-- DataTables -->
    <link rel="stylesheet" type="text/css" href="js/jquery.dataTables.css">
    <!-- Modaal -->
    <link rel="stylesheet" type="text/css" href="js/modaal.min.css">
    <!-- select2 -->
    <link rel="stylesheet" type="text/css" href="js/select2-4.0.3.min.css">
    <link rel="stylesheet" type="text/css" href="js/select2totree.css">
    <!-- datatimepicker -->
    <link rel="stylesheet" type="text/css" href="js/jquery.datetimepicker.css">
    <!-- PLOD -->
    <link rel="stylesheet" type="text/css" href="js/plod-style.css" -->

    <!--script src="https://code.jquery.com/jquery-1.11.1.min.js"></script-->
    <script language="javascript" src="js/jquery-3.3.1.min.js"></script>
    <!-- DataTables -->
    <script language="javascript" src="js/jquery.dataTables.js"></script>
    <!-- Modaal -->
    <script language="javascript" src="js/modaal.min.js"></script>
    <!-- select2 -->
    <script src="js/select2-4.0.3.min.js"></script>
    <script src="js/select2totree.js"></script>
    <!-- datatimepicker -->
    <script src="js/jquery.datetimepicker.full.min.js"></script>

    <!-- PLOD -->
    <script src="js/plod-conf.js"></script>
    <script src="js/plod-listview.js"></script>
    <script src="js/lglist-select2-20200327.js"></script>
    <script type="text/javascript" language="javascript" class="init">

window.addEventListener("load", ev_load, false);

jQuery.datetimepicker.setLocale(plod_locale);

let plod_table;

/*
 * NOTE: if you change the value of the lists.
 * you have to check value_selected in below functions.
 */

/* options for select */
let publisherList = [];
let locationList = [];
let residenceList = [];

// key -> text
// value -> id

const re_PLHDepartureDate = new RegExp("PLHDepartureDate\\d+$");
const re_PLHDepartureTime = new RegExp("PLHDepartureTime\\d+$");
const re_PLHDepartureFromSelected = new RegExp("PLHDepartureFrom\\d+Selected$");
const re_PLHDepartureFromText = new RegExp("PLHDepartureFrom\\d+Text$");
const re_PLHArrivalDate = new RegExp("PLHArrivalDate\\d+$");
const re_PLHArrivalTime = new RegExp("PLHArrivalTime\\d+$");
const re_PLHArrivalInSelected = new RegExp("PLHArrivalIn\\d+Selected$");
const re_PLHArrivalInText = new RegExp("PLHArrivalIn\\d+Text$");
const re_PLHDetailsTextarea = new RegExp("PLHDetails\\d+Textarea$");
const re_PCHDate = new RegExp("PCHDate\\d+$");
const re_PCHTime = new RegExp("PCHTime\\d+$");
const re_PCHDetailsTextarea = new RegExp("PCHDetails\\d+Textarea$");

function debug_table(table)
{
    console.log("xxx === debug_table() ===");
    for (var r = 0, n = table.rows.length; r < n; r++) {
        for (var c = 0, m = table.rows[r].cells.length; c < m; c++) {
            console.log("xxx cell():", r, c, table.rows[r].cells[c]);
        }
    }
}

function add_input_textarea(parent_obj, target_id, args)
{
    /*
     * args must include:
     *     clear_content
     *     initial_value
     *     placeholder_text
     * options:
     *     label_name
     *
     * it makes below id:
     *     target_id + "Textarea"
     *
     * the block is gonna be:
     *   <fieldset class="no-border no-magin">
     *     <textarea id=`${target_id}Textarea` placeholder=args.placeholder_text>
     *   </fieldset>
     *
     * or, if label_name exists,
     *   <fieldset class="no-border no-magin">
     *     <legend class="label top-label" for= `${target_id}Textarea` > args.label_name </label>
     *     <textarea id=`${target_id}Textarea` placeholder=args.placeholder_text>
     *   </fieldset>
     */
    let child, x;
    let id_name = `${target_id}Textarea`;

    if (args.clear_content == true) {
        parent_obj.innerHTML = "";
    }

    child = document.createElement("fieldset");
    child.classList.add("no-border");
    child.classList.add("no-margin");

    if (args.label_name) { /* not undefind and not false */
        x = document.createElement("legend");
        x.htmlFor = id_name;
        x.innerHTML = args.label_name;
        x.classList.add("label");
        x.classList.add("top-label");
        child.appendChild(x);
    }

    x = document.createElement("textarea");
    x.id = id_name;
    x.setAttribute("style", "width: 90%;");
    x.placeholder = args.placeholder_text;
    if (args.initial_value != undefined && args.initial_value != "") {
        x.innerText = args.initial_value;
    }

    child.appendChild(x);
    parent_obj.appendChild(child);
}

function add_input_checkbox_and_textarea(parent_obj, target_name, args)
{
    /*
     * args must include:
     *     clear_content
     *     item_list
     *     initial_checked
     *     need_input_text
     *     initial_text
     *     placeholder_text
     *
     * it makes below id:
     *     the name of the checkboxe is taken from "name" in the item_list.
     *     target_id + "Text"
     *
     * don't use id to identify a checkbox.
     *
     *   <div class="inline-block">
     *     <div class=`Checkbox-${args.target_name}`>
     *       <input type="checkbox" name=kv["name"]>
     *       <label name=${kv.name}>kv.key</label>
     *     </div>
     *     <div> ... </div>
     *     --> add_input_texteat() <--
     *   </div>
     */
    let child, cb, x;

    if (args.clear_content == true) {
        parent_obj.innerHTML = "";
    }

    child = document.createElement("span");
    args.item_list.forEach(kv => {
        cb = document.createElement("div")
        //cb.classList.add(`Checkbox-${target_name}`);
        cb.classList.add("inline-block");

        x = document.createElement("input");
        x.type = "checkbox";
        x.name = kv["id"];
        if (args.initial_checked != undefined && args.initial_checked.find(x => x == kv["id"]) != undefined) {
            x.checked = true;
        }
        cb.appendChild(x);

        x = document.createElement("label")
        //x.htmlFor = kv["id"]
        x.appendChild(document.createTextNode(kv["text"]));
        cb.appendChild(x);

        child.appendChild(cb);
    });

    if (args.need_input_text == true) {
        add_input_textarea(child, target_name, {
            clear_content: false,
            initial_value: args.initial_text,
            placeholder_text: args.placeholder_text,
        });
    }

    parent_obj.appendChild(child);
}

function add_input_select_options_to_obj(parent_obj, opts, value_selected)
{
    /*
     * parent_obj, not parent_id, should be passed here.
     * because the parent_id is not listed in the document level list.
     */
    opts.forEach(x => {
        let opt = document.createElement("option");
        opt.text = x["key"];
        opt.value = x["value"];
        if (value_selected != null && x["value"] == value_selected) {
            opt.selected = true;
        }
        parent_obj.add(opt, null);
    });
}

function add_input_select_and_text(parent_obj, target_id, args)
{
    /*
     * args must include:
     *     clear_content
     *     select_list
     *     value_selected
     *     label_name
     *     need_input_text
     *     initial_text
     *     placeholder_text
     *
     * it makes below id:
     *     target_id + "Selected"
     *     target_id + "Text"
     *
     * <div class="inline-block">
     *   <label class="label left-label" for={target_id}+"Selected">{args.label_name}</label>
     *   <select class="input-select" id={target_id}+"Selected">
     *     <option> select2+tree </option>
     *   </select>
     *   --> add_input_text() <--
     * </div>
     *
     * if args.need_input_text is true, the input text is gonna be added by add_input_text().
     *
     * check if;
     *     args.select_list has "id", then it's for select2.
     *     args.select_list has "key", then t's for select.
     *
     * note if args.value_selected doesn't apper, you should check if the value exists in the args.select_list.
     *
     */
    let child, x;

    if (args.clear_content == true) {
        parent_obj.innerHTML = "";
    }
    child = document.createElement("div");
    child.classList.add("inline-block");
    if (args.label_name != undefined) {
        x = document.createElement("label");
        x.htmlFor = target_id + "Selected";
        x.innerHTML = args.label_name;
        x.classList.add("label");
        x.classList.add("left-label");
        child.appendChild(x);
    }
    x = document.createElement("select");
    x.id = target_id + "Selected";
    child.appendChild(x);

    if (args.select_list[0].id) {
        jQuery(x).select2ToTree({
            treeData: {dataArr: args.select_list},
            multiple: false,
            dropdownAutoWidth: "auto",
            width: "auto",
            //dropdownParent: jQuery(parent_obj).parents("[id^='modaal_']"),
            dropdownParent: jQuery("#divResidence"),
        }).val(args.value_selected).trigger("change");
    } else if (args.select_list[0].key) {
        add_input_select_options_to_obj(x, args.select_list, args.value_selected);
    }

    if (args.need_input_text == true) {
        add_input_text(child, target_id, {
            clear_content: false,
            initial_value: args.initial_text,
            label_name: undefined,
            placeholder_text: args.placeholder_text,
        });
    }

    parent_obj.appendChild(child);
}

function get_current_date()
{
    let local_time = new Date();
    return local_time.toJSON().slice(0,10);
}

function add_input_date_to_obj(parent_obj, target_id, initial_value)
{
    let x = document.createElement("input");
    x.type = "text";
    x.id = target_id;
    x.classList.add("inputDate");
    parent_obj.appendChild(x);
    jQuery(x).val(initial_value);
    jQuery(x).datetimepicker({
        timepicker: false,
        format: "Y-m-d",
        scrollMonth : false,    // disable scroll in both.
        //scrollInput : false,    // disable scroll in the text field.
    });
}

function add_input_time_to_obj(parent_obj, target_id, initial_value)
{
    let local_time = new Date();
    let x = document.createElement("input");
    x.type = "text";
    x.id = target_id;
    x.placeholder = M_PLACEHOLDER_TIME;
    x.classList.add("inputTime");
    parent_obj.appendChild(x);
    jQuery(x).val(initial_value);
    jQuery(x).datetimepicker({
        datepicker: false,
        format: "H:i",
        step: 30,
        defaultTime: "12:00",
    });
}

function add_input_date_time_to_obj_x(parent_obj, date_target_id, date_initial, time_target_id, time_initial, label_name, line_break)
{
    let child, x;

    child = document.createElement("div");
    child.classList.add("inline-block");
    if (label_name != undefined) {
        x = document.createElement("label");
        x.htmlFor = date_target_id;
        x.innerHTML = label_name;
        x.classList.add("label");
        x.classList.add("left-label");
        child.appendChild(x);
    }
    add_input_date_to_obj(child, date_target_id, date_initial);
    if (time_target_id != null) {
        if (line_break == true) {
            child.appendChild(document.createElement("br"));
        }
        add_input_time_to_obj(child, time_target_id, time_initial);
    }
    parent_obj.appendChild(child);
}

function add_input_text(parent_obj, target_id, args)
{
    /*
     * args must inlucde:
     *     clear_content
     *     initial_value
     *     label_name
     *     placeholder_text
     *
     * it makes two ids:
     *     target_id + "Text"
     *
     * the block gonna be:
     *   <div class="inline-block">
     *     <label class="label left-label" for=`${target_id}Text`> args.label_name </label>
     *     <input id=`${target_id}Text` class="input-text" type="text" vlaue=args.initial_value placeholder=args.placeholder_text>
     *   </div>
     *
     */
    let child, x;

    if (args.clear_content == true) {
        parent_obj.innerHTML = "";
    }
    child = document.createElement("div");
    child.classList.add("inline-block");
    if (args.label_name != undefined) {
        x = document.createElement("label");
        x.htmlFor = target_id + "Text";
        x.innerHTML = args.label_name;
        x.classList.add("label");
        x.classList.add("left-label");
        child.appendChild(x);
    }
    x = document.createElement("input");
    x.id = target_id + "Text";
    x.type = "text";
    x.classList.add("input-text");
    if (args.initial_value != undefined) {
        x.value = args.initial_value;
    }
    if (args.placeholder_text != undefined) {
        x.placeholder = args.placeholder_text;
    }
    child.appendChild(x);

    parent_obj.appendChild(child);
}

function get_default_PLOD()
{
    let default_plod = JSON.parse(JSON.stringify(DEFAULT_PLOD));
    default_plod.dateConfirmed = get_current_date();
    return DEFAULT_PLOD;
}

function get_default_PLH(base_row)
{
    let default_PLH = {
        "departureDate": "",
        "departureTime": "",
        "departureFrom": "",
        "departureFromAnnex": "",
        "arrivalDate": "",
        "arrivalTime": "",
        "arrivalIn": "",
        "arrivalInAnnex": "",
        "vehicles": [],
        "vehicleOthers": "",
        "details": "",
    };
    let tbody = document.getElementById("tablePLH").getElementsByTagName('tbody')[0];
    /* set ref_row if possible */
    let ref_row;
    if (base_row == undefined || base_row == null) {
        if (tbody.rows.length > 0) {
            ref_row = tbody.rows[tbody.rows.length-1];
        }
    } else if (base_row.rowIndex >= 2) {
        ref_row = tbody.rows[base_row.rowIndex-2];
    }
    if (ref_row == undefined) {
        let default_location = document.getElementById("residenceSelected").value;
        default_PLH.departureFrom = default_location;
        default_PLH.departureDate = get_current_date();
        default_PLH.arrivalIn = default_location;
        default_PLH.arrivalDate = get_current_date();
        return default_PLH;
    }
    /* inserting a row with the referring row. */
    default_PLH.departureDate = get_one_element_by_regex(ref_row.cells[2], re_PLHArrivalDate).value;
    default_PLH.departureTime = get_one_element_by_regex(ref_row.cells[2], re_PLHArrivalTime).value;
    default_PLH.departureFrom = get_one_element_by_regex(ref_row.cells[3], re_PLHArrivalInSelected).value;
    default_PLH.departureFromAnnex = get_one_element_by_regex(ref_row.cells[3], re_PLHArrivalInText).value;
    default_PLH.arrivalDate = get_one_element_by_regex(ref_row.cells[2], re_PLHArrivalDate).value;
    default_PLH.arrivalTime = get_one_element_by_regex(ref_row.cells[2], re_PLHArrivalTime).value;
    default_PLH.arrivalIn = get_one_element_by_regex(ref_row.cells[1], re_PLHDepartureFromSelected).value;
    default_PLH.arrivalInAnnex = get_one_element_by_regex(ref_row.cells[1], re_PLHDepartureFromText).value;
    return default_PLH;
}

function get_default_PCH(base_row)
{
    let default_PCH = {
        "conditionDate": "",
        "conditionTime": "",
        "conditions": [],
        "conditionOthers": "",
        "details": "",
    };
    let tbody = document.getElementById("tablePCH").getElementsByTagName('tbody')[0];
    /* set ref_row if possible */
    let ref_row;
    if (base_row == undefined || base_row == null) {
        if (tbody.rows.length > 0) {
            ref_row = tbody.rows[tbody.rows.length-1];
        }
    } else if (base_row.rowIndex >= 2) {
        ref_row = tbody.rows[base_row.rowIndex-2];
    }
    if (ref_row == undefined) {
        /* inserting a row with default */
        default_PCH.conditionDate = get_current_date();
        return default_PCH;
    }
    /* inserting a row with the referring row. */
    default_PCH.conditionDate = get_one_element_by_regex(ref_row.cells[0], re_PCHDate).value;
    default_PCH.conditionTime = get_one_element_by_regex(ref_row.cells[0], re_PCHTime).value;
    return default_PCH;
}

function add_input_button_ins_line(parent_obj, row)
{
    let x = document.createElement("input");
    x.classList.add("control-button");
    x.type = "button";
    x.value = M_BUTTON_ADD_ABOVE;
    x.addEventListener("click", function(){ ev_click_ins_line(row) }, false);
    parent_obj.appendChild(x);
}

function add_input_button_del_line(parent_obj, row)
{
    let x = document.createElement("input");
    x.classList.add("control-button");
    x.type = "button";
    x.value = M_BUTTON_DELETE_THIS;
    x.addEventListener("click", function(){ ev_click_del_line(row) }, false);
    parent_obj.appendChild(x);
}

function ins_line_PLHTable(row_index_ins, initial_value)
{
    let tbody = document.getElementById("tablePLH").getElementsByTagName('tbody')[0];
    let row = tbody.insertRow(row_index_ins);
    let row_index = tbody.rows.length;
    let row_num = Math.random().toString().slice(-8);
    let x, x2, x3, cell;

    /* PLHDepartureDate and PLHDepartureTime */
    cell = row.insertCell(-1);
    add_input_date_time_to_obj_x(cell, "PLHDepartureDate"+row_num, initial_value.departureDate, "PLHDepartureTime" + row_num, initial_value.departureTime, undefined, true);

    /* PLHDepartureFrom */
    cell = row.insertCell(-1);
    add_input_select_and_text(cell, "PLHDepartureFrom"+row_num, {
        clear_content: true,
        select_list: locationList,
        value_selected: initial_value.departureFrom,
        label_name: undefined,
        need_input_text: true,
        initial_text: initial_value.departureFromAnnex,
        placeholder_text: M_PLACEHOLDER_LOCATION_ANNEX,
    });

    /* PLHArrivalDateTime */
    cell = row.insertCell(-1);
    add_input_date_time_to_obj_x(cell, "PLHArrivalDate"+row_num, initial_value.departureDate, "PLHArrivalTime" + row_num, initial_value.departureTime, undefined, true);

    /* PLHArrivalIn */
    cell = row.insertCell(-1);
    add_input_select_and_text(cell, "PLHArrivalIn"+row_num, {
        clear_content: true,
        select_list: locationList,
        value_selected: initial_value.arrivalIn,
        label_name: undefined,
        need_input_text: true,
        initial_text: initial_value.arrivalInAnnex,
        placeholder_text: M_PLACEHOLDER_LOCATION_ANNEX,
    });

    /* vehicles */
    cell = row.insertCell(-1);
    add_input_checkbox_and_textarea(cell, "vehicles"+row_num, {
        clear_content: true,
        item_list: vehiclesList,
        initial_checked: initial_value.vehicles,
        need_input_text: true,
        initial_text: initial_value.vehicleOthers,
        placeholder_text: M_PLACEHOLDER_VEHICLE_TEXT,
    });

    /* PLHDetails */
    cell = row.insertCell(-1);
    add_input_textarea(cell, "PLHDetails"+row_num, {
        clear_content: false,
        initial_value: initial_value.details,
        label_name: false,
        placeholder_text: M_PLACEHOLDER_PLH_ANNEX,
    });

    /* DelLine */
    cell = row.insertCell(-1);
    add_input_button_ins_line(cell, row);
    cell.appendChild(document.createElement("br"));
    add_input_button_del_line(cell, row);
}

function ins_line_PCHTable(row_index_ins, initial_value)
{
    let tbody = document.getElementById("tablePCH").getElementsByTagName('tbody')[0];
    let row = tbody.insertRow(row_index_ins);
    let row_index = tbody.rows.length;
    let row_num = Math.random().toString().slice(-8);
    let x, x2, x3, cell;

    /* PCHDate, PCHTime */
    cell = row.insertCell(-1);
    add_input_date_time_to_obj_x(cell, "PCHDate"+row_num, initial_value.conditionDate, "PCHTime" + row_num, initial_value.conditionTime, undefined, true);

    /* PCHConditios */
    cell = row.insertCell(-1);
    add_input_checkbox_and_textarea(cell, "conditions"+row_num, {
        clear_content: true,
        item_list: patientConditionList,
        initial_checked: initial_value.conditions,
        need_input_text: false,
    });

    /* PCHDetails */
    cell = row.insertCell(-1);
    add_input_textarea(cell, "PCHDetails"+row_num, {
        clear_content: false,
        initial_value: initial_value.details,
        label_name: false,
        placeholder_text: M_PLACEHOLDER_PCH_ANNEX,
    });

    /* DelLine */
    cell = row.insertCell(-1);
    add_input_button_ins_line(cell, row);
    cell.appendChild(document.createElement("br"));
    add_input_button_del_line(cell, row);
}

/*
 * functions for submission
 */
function get_selected_value(target_id)
{
    /*
     * return value or undefined.
     * if the value is "", it returns undefined.
     */
    let x = document.getElementById(target_id);
    let selected_value = x.options[x.selectedIndex].value;
    if (selected_value != "") {
        return selected_value;
    } else {
        return undefined;
    }
}

/*
 * XXX should be replaced into jQuery().
 */
function get_one_element_by_regex(parent_obj, target_regex)
{
    /*
     * comparing id under parent_obj with target_regex recursively.
     */
    let x, a;

    if (parent_obj.id && parent_obj.id.match(target_regex)) {
//console.log("==> match", parent_obj.id);
        return parent_obj;
    }

    if (parent_obj.children == undefined) {
        return undefined;
    }

    /* first, walk this level. */
    for (let i = 0; i < parent_obj.childNodes.length; i++) {
        x = parent_obj.childNodes[i];
//console.log("==> xxx by_regex:", i, x.id, target_regex, x);
        a = get_one_element_by_regex(x, target_regex);
        if (a != undefined) {
            return a;
        }
    }

    return undefined;
}

function check_value_and_other(main_value, other_value)
{
    if (other_value == "" || other_value == undefined) {
        return true;
    }
    /* other_value has something. */
    if (main_value != "Other") {
        return false;
    }
    return true;
}

function make_data_entries()
{
    let data_entered = {
        "publisher": get_selected_value("publisherSelected"),
        "publisherOthers": document.getElementById("publisherText").value,
        "localId": document.getElementById("localIdText").value,
        "localSubId": document.getElementById("localSubIdText").value,
        "disease": get_selected_value("diseaseSelected"),
        "diseaseOthers": document.getElementById("diseaseText").value,
        "dateConfirmed": document.getElementById("dateConfirmed").value,
        "age": get_selected_value("ageSelected"),
        "gender": get_selected_value("genderSelected"),
        "residence": document.getElementById("residenceSelected").value,
        "residenceAnnex": document.getElementById("residenceText").value,
        "closeContacts": document.getElementById("closeContactsTextarea").value,
        "locationHistory": [
        ],
        "conditionHistory": [
        ]
    };

    /* put _id and/or reportId if exists. */
    if (g_form_value.reportId != undefined) {
        data_entered.reportId = g_form_value.reportId;
    }

    /* check the field of publisher and disease */
    if (check_value_and_other(data_entered["publisher"], data_entered["publisherOthers"]) == false) {
        window.alert("publisher" + M_ALERT_SELECT_OTHERS_AND_INPUT);
        return false;
    }
    if (check_value_and_other(data_entered["disease"], data_entered["diseaseOthers"]) == false) {
        window.alert("disease" + M_ALERT_SELECT_OTHERS_AND_INPUT);
        return false;
    }

    let table;

    table = document.getElementById("tablePLH");
    //debug_table(table);

    for (let i = 1; i < table.rows.length; i++) {
        //console.log("xxx PLH table:", i, table.rows[i]);
        let kv = {};
        let row = table.rows[i];
        kv["departureDate"] = get_one_element_by_regex(row.cells[0], re_PLHDepartureDate).value;
        kv["departureTime"] = get_one_element_by_regex(row.cells[0], re_PLHDepartureTime).value;
        kv["departureFrom"] = get_one_element_by_regex(row.cells[1], re_PLHDepartureFromSelected).value;
        kv["departureFromAnnex"] = get_one_element_by_regex(row.cells[1], re_PLHDepartureFromText).value;
        kv["arrivalDate"] = get_one_element_by_regex(row.cells[2], re_PLHArrivalDate).value;
        kv["arrivalTime"] = get_one_element_by_regex(row.cells[2], re_PLHArrivalTime).value;
        kv["arrivalIn"] = get_one_element_by_regex(row.cells[3], re_PLHArrivalInSelected).value;
        kv["arrivalInAnnex"] = get_one_element_by_regex(row.cells[3], re_PLHArrivalInText).value;
        kv["vehicles"] = [];
        row.cells[4].childNodes.forEach(x => { // vehicles
            x.childNodes.forEach(y => {
                if (y.firstChild.type == "checkbox" && y.firstChild.checked == true) {
                    kv["vehicles"].push(y.firstChild.name);
                }
                if (y.firstChild.type == "textarea") {
                    kv["vehicleOthers"] = y.firstChild.value;
                }
            });
        });
        /* add vehicleOthers if not exists. */
        if (kv.vehicleOthers == undefined) {
            kv["vehicleOthers"] = "";
        }
        kv["details"] = get_one_element_by_regex(row.cells[5], re_PLHDetailsTextarea).value;
        data_entered["locationHistory"].push(kv);
    }

    table = document.getElementById("tablePCH");
    //debug_table(table);

    for (let i = 1; i < table.rows.length; i++) {
        //console.log("xxx PCH table:", i, table.rows[i]);
        let kv = {};
        let row = table.rows[i];
        kv["conditionDate"] = get_one_element_by_regex(row.cells[0], re_PCHDate).value;
        kv["conditionTime"] = get_one_element_by_regex(row.cells[0], re_PCHTime).value;
        kv["conditions"] = [];
        row.cells[1].childNodes.forEach(x => { // PCHStatus
            x.childNodes.forEach(y => {
                if (y.firstChild.type == "checkbox" && y.firstChild.checked == true) {
                    kv["conditions"].push(y.firstChild.name);
                }
                // temporally removed: discussed with Tsuna-san, 26-Apr-2020
                //if (y.firstChild.type == "textarea") {
                //    kv["conditionOthers"] = y.firstChild.value;
                //}
            });
        });
        /* add conditionOthers if not exists. */
        if (kv.conditionOthers == undefined) {
            kv["conditionOthers"] = "";
        }
        kv["details"] = get_one_element_by_regex(row.cells[2], re_PCHDetailsTextarea).value;
        data_entered["conditionHistory"].push(kv);
    }

    return data_entered;
}

async function send_plod(patient_data)
{
    fetch("/beak", {
        method: "POST",
        headers: { "Content-Type": "application/json; charset=utf-8" },
        body: JSON.stringify(patient_data),
    }).then(response => {
        return response.json();
    }).then(content => {
//console.log("content:", content);
        let status = content["result"];
        if (status == "success") {
            let data = content["plod"];
            confirm("reportId " + data["reportId"] + M_CONFIRM_PLOD_CREATED);
            // XXX needs to decide whehter new record is added to local table or just reload.
            //plod_table.row.add(data).draw();
            window.location.reload(false);
        } else {
            confirm("reportId " + data["reportId"] + M_CONFIRM_PLOD_FAILED_CREATION + "status=" + status);
        }
    }).catch(error => {
        console.error("Error:", error);
    });
}

async function delete_plod(reportId)
{
    fetch("/tail/" + reportId, {
        method: "DELETE",
    }).then(response => {
        return response.json();
    }).then(content => {
//console.log("content:", content);
        let status = content["result"];
        if (status == "success") {
            confirm("reportId " + reportId + M_CONFIRM_PLOD_DELETED);
            // XXX needs to decide whehter new record is deleted from local table or just reload.
            window.location.reload(false);
        } else {
            confirm("reportId " + reportId + M_CONFIRM_PLOD_FAILED_DELETION + "status=" + status);
        }
    }).catch(error => {
        console.error("Error:", error);
    });
}

/*
 * event handlers
 */
function ev_click_add_line_PLHTable()
{
    ins_line_PLHTable(-1, get_default_PLH());
}

function ev_click_add_line_PCHTable()
{
    ins_line_PCHTable(-1, get_default_PCH());
}

function ev_click_ins_line(row)
{
    if (row.parentElement.parentElement.id == "tablePLH") {
        ins_line_PLHTable(row.rowIndex-1, get_default_PLH(row));
    } else
    if (row.parentElement.parentElement.id == "tablePCH") {
        ins_line_PCHTable(row.rowIndex-1, get_default_PCH(row));
    }
}

function plod_form_table_del_line(row)
{
    jQuery(row).find(".inputDate").datetimepicker("destroy");
    jQuery(row).find(".inputTime").datetimepicker("destroy");
    jQuery(row).remove();
}

function plod_form_table_destroy(target_id)
{
    let t = document.getElementById(target_id).getElementsByTagName('tbody')[0];
    /* it's tricky.  n must be preserved. */
    for (let i = 0, n = t.childNodes.length; i < n; i++) {
        plod_form_table_del_line(t.childNodes[0]);
    }
}

function plod_form_reset()
{
    $('#modal-control-form').modaal('close');
    jQuery("#dateConfirmed").datetimepicker("destroy");
    plod_form_table_destroy("tablePLH");
    plod_form_table_destroy("tablePCH");
}

function ev_click_del_line(row)
{
    if (true == confirm(M_CONFIRM_PLOD_ASK_DELETION)) {
        plod_form_table_del_line(row);
    }
}

function plod_form_submit()
{
    let data_entered = make_data_entries();
    if (data_entered == false) {
        return false;
    }
    send_plod(data_entered);
    $('#modal-control-confirm-entry').modaal('close');
    g_form_value = null;
    plod_form_reset();
}

function plod_form_create()
{
    let x;

//console.log(g_form_value);

    /* layout the edit blocks */
    add_input_select_and_text(document.getElementById("divPublisher"), "publisher", {
        clear_content: true,
        select_list: publisherList,
        value_selected: g_form_value.publisher,
        label_name: headers_base.filter(x => x["key"] == "publisher")[0].notation,
        need_input_text: true,
        initial_text: g_form_value.publisherOthers,
        placeholder_text: M_PLACEHOLDER_SELECT_OTHER_AND_INPUT,
    });

    add_input_text(document.getElementById("divLocalId"), "localId", {
        clear_content: true,
        label_name: headers_base.filter(x => x["key"] == "localId")[0].notation,
        initial_value: g_form_value.localId,
        placeholder_text: M_PLACEHOLDER_LOCALID,
    });

    add_input_text(document.getElementById("divLocalSubId"), "localSubId", {
        clear_content: true,
        label_name: headers_base.filter(x => x["key"] == "localSubId")[0].notation,
        initial_value: g_form_value.localSubId,
        placeholder_text: M_PLACEHOLDER_LOCALSUBID,
    });

    add_input_select_and_text(document.getElementById("divDisease"), "disease", {
        clear_content: true,
        select_list: diseaseList,
        value_selected: g_form_value.disease,
        label_name: headers_base.filter(x => x["key"] == "disease")[0].notation,
        need_input_text: true,
        initial_text: g_form_value.diseaseOthers,
        placeholder_text: M_PLACEHOLDER_SELECT_OTHER_AND_INPUT,
    });

    x = document.getElementById("divDateConfirmed");
    x.innerHTML = "";
    add_input_date_time_to_obj_x(x, "dateConfirmed", g_form_value.dateConfirmed, undefined, undefined,
        headers_base.filter(x => x["key"] == "dateConfirmed")[0].notation);

    add_input_select_and_text(document.getElementById("divAge"), "age", {
        clear_content: true,
        select_list: ageList,
        value_selected: g_form_value.age,
        label_name: headers_base.filter(x => x["key"] == "age")[0].notation,
        need_input_text: false,
    });

    add_input_select_and_text(document.getElementById("divGender"), "gender", {
        clear_content: true,
        select_list: genderList,
        value_selected: g_form_value.gender,
        label_name: headers_base.filter(x => x["key"] == "gender")[0].notation,
        need_input_text: false,
    });

    add_input_select_and_text(document.getElementById("divResidence"), "residence", {
        select_list: residenceList,
        value_selected: g_form_value.residence,
        label_name: headers_base.filter(x => x["key"] == "residence")[0].notation,
        need_input_text: true,
        initial_text: g_form_value.residenceAnnex,
        placeholder_text: M_PLACEHOLDER_RESIDENCEANNEX,
        clear_content: true,
    });

    /* lines for location history */
    document.getElementById("tablePLH").getElementsByTagName('tbody')[0].innerHTML = "";
    if (g_form_value.locationHistory.length > 0) {
        g_form_value.locationHistory.forEach(x => ins_line_PLHTable(-1, x));
    }

    /* lines for condition history */
    document.getElementById("tablePCH").getElementsByTagName('tbody')[0].innerHTML = "";
    if (g_form_value.conditionHistory.length > 0) {
        g_form_value.conditionHistory.forEach(x => ins_line_PCHTable(-1, x));
    }

    add_input_textarea(document.getElementById("divCloseContacts"), "closeContacts", {
        clear_content: true,
        initial_value: g_form_value.closeContacts,
        placeholder_text: M_PLACEHOLDER_CLOSECONTACTS,
        label_name: headers_base.filter(x => x["key"] == "closeContacts")[0].notation,
    });
}

function ev_load(e)
{
    plod_listview_init(document.getElementById("plod-list"), { "enable_delete_button": true });

    /*
     * create select-lists from lgList.
     *   publisherList: Others, MHLW
     *   locationList: Others, Abroad
     *   residenceList: Others, Abroad, Unspecified
     */
    publisherList = JSON.parse(JSON.stringify(lgList))
    publisherList.unshift(SELECT_OPT_MHLW);
    publisherList.push(SELECT_OPT_OTHER);

    residenceList = JSON.parse(JSON.stringify(lgList));
    residenceList.unshift(SELECT_OPT_UNSPECIFIED);
    residenceList.push(SELECT_OPT_JAPAN);
    residenceList.push(SELECT_OPT_ABROAD);
    residenceList.push(SELECT_OPT_OTHER);

    locationList = JSON.parse(JSON.stringify(lgList));
    locationList.unshift(SELECT_OPT_UNSPECIFIED);
    locationList.push(SELECT_OPT_ABROAD);
    locationList.push(SELECT_OPT_JAPAN);
    locationList.push(SELECT_OPT_OTHER);

    /* modal */
    $('#modal-control-form').modaal({
        content_source: '#divEntryForm',
        fullscreen: 'true',
        hide_close: true,
    });

    $('#modal-control-confirm-entry').modaal({
        content_source: '#divConfirmSubmit',
    });

    $('#button-confirm-entry').on("click", function() {
        let data_entered = make_data_entries();
        if (data_entered == false) {
            return false;
        }
        let x = document.getElementById("divConfirmEntry");
        x.innerText = JSON.stringify(data_entered, undefined, 2);
        $('#modal-control-confirm-entry').modaal('open');
    });

    jQuery("#button-no-confirm-entry").on("click", function() {
        $('#modal-control-confirm-entry').modaal('close');
    });

    jQuery("#button-yes-confirm-entry").on("click", function() {
        plod_form_submit();
    });

    $('#button-plod-edit').click( function () {
        if (plod_table.row('.selected').length != 0) {
            g_form_value = plod_table.row('.selected').data();
            plod_form_create();
            $('#modal-control-form').modaal('open');
        } else {
            alert(M_ALERT_SELECT_DATA);
        }
    });

    document.getElementById("button-plod-new").addEventListener("click", function() {
        g_form_value = get_default_PLOD();
        plod_form_create();
        $('#modal-control-form').modaal('open');
    }, false);

    document.getElementById("button-submit-entry").addEventListener("click", function() {
        if (true == confirm(M_CONFIRM_SUBMIT_DATA)) {
            plod_form_submit();
        }
    }, false);

    document.getElementById("button-cancel-entry").addEventListener("click", function () {
        if (true == confirm(M_CONFIRM_CANCEL_SUBMISSION)) {
	    plod_form_reset();
	}
    });

    document.getElementById("addLinePLH").addEventListener("click", ev_click_add_line_PLHTable, false);
    document.getElementById("addLinePCH").addEventListener("click", ev_click_add_line_PCHTable, false);

}

    </script>

</head>
<body>

    <!-- window for list view -->
    <div id="divListView">
        <div id="divEntryFormTitle">
            <div style="display:inline-block; vertical-align:top;">
                <a href="images/PLOD-v0.1.png">
                    <img id="plodLogo" src="images/PLOD-v0.1-48x48.png" alt="PLOD logo">
                </a>
            </div>
            <div style="display:inline-block; width:90%;">
                <span>Patient Locational Open Data (PLOD) List View</span>
                <br>
                <span>
                    　
                </span>
            </div>
        </div>
        <hr>

        <div class="inline-block div-block" style="width:100%; margin-right:3px;">
            <span>
                <input id="button-plod-edit" class="control-button" type="button" value="選択したPLODを編集する">
            </span>
            <span style="float:right; margin-right:5px;">
                <input id="button-plod-new" class="control-button" type="button" value="新しいPLODを入力する">
            </span>
        </div>

        <hr>

        <table id="plod-list" class="display" style="width:98%"></table>
    </div>

    <!-- window for entry form -->
    <div id="modal-control-form"></div>
    <div id="divEntryForm" style="display:none;">
        <div id="divEntryFormTitle">
            <div style="display:inline-block; vertical-align:top;">
                <a href="images/PLOD-v0.1.png">
                    <img id="plodLogo" src="images/PLOD-v0.1-48x48.png" alt="PLOD logo">
                </a>
            </div>
            <div style="display:inline-block; width:90%;">
                <span>Patient Locational Open Data (PLOD) Entry Form</span>
                <br>
                <span>
                    位置情報の入力に関するガイド:
                    患者のプライバシーを考慮しつつ、かつ、
                    移動した場所がある程度特定できるように入力してください。
                </span>
            </div>
        </div>
        <hr>

        <div class="inline-block">
            <div id="divPublisher" class="inline-block div-block inset-box"> <!-- insert dynamically --> </div>
            <div id="divLocalId" class="inline-block div-block inset-box"> <!-- insert dynamically --> </div>
            <div id="divLocalSubId" class="inline-block div-block inset-box"> <!-- insert dynamically --> </div>
        </div>

        <div class="inline-block">
            <div id="divDisease" class="inline-block div-block inset-box"> <!-- insert dynamically --> </div>
            <div id="divDateConfirmed" class="inline-block div-block inset-box"> <!-- insert dynamically --> </div>
        </div>

        <div class="inline-block">
            <div id="divAge" class="inline-block div-block inset-box"> <!-- insert dynamically --> </div> 
            <div id="divGender" class="inline-block div-block inset-box"> <!-- insert dynamically --> </div> 
            <div id="divResidence" class="inline-block div-block inset-box"> <!-- insert dynamically --> </div>
        </div>

        <hr>
        <div class="inline-block div-block">
            <label for="divPLH">患者の移動の履歴:</label>
            <div id="divPLH">
                <table id="tablePLH" class="table-form">
                    <thead>
                        <tr>
                            <th>出発日時</th>
                            <th>出発地</th>
                            <th>到着日時</th>
                            <th>到着地</th>
                            <th>移動方法(複数選択可)</th>
                            <th>所見や患者の行動等</th>
                            <th>行増減</th>
                        </tr>
                    </thead>
                    <tbody> <!-- insert dynamically --> </tbody>
                </table>
                <input id="addLinePLH" class="control-button" type="button" value="↑行を追加する">
            </div>
        </div>

        <hr>
        <div class="inline-block div-block">
            <label for="divPCH">患者の状態の履歴:</label>
            <div id="divPCH">
                <table id="tablePCH" class="table-form">
                    <thead>
                        <tr>
                            <th>日付</th>
                            <th>健康状態</th>
                            <th>自由記述欄</th>
                            <th>行増減</th>
                        </tr>
                    </thead>
                    <tbody> <!-- insert dynamically --> </tbody>
                </table>
                <input id="addLinePCH" class="control-button" type="button" value="↑行を追加する">
            </div>
        </div>

        <hr>
        <div id="divCloseContacts" class="div-block"> <!-- insert dynamically --> </div>

        <hr>
        <div>
            <div class="inline-block div-block" style="width:98%; margin-right:3px;">
                <span>
                    <input id="button-confirm-entry" class="control-button" type="button" value="確認する">
                    <input id="button-submit-entry" class="control-button" type="button" value="登録する">
                </span>
                <span style="float:right; margin-right:5px;">
                    <input id="button-cancel-entry" class="control-button" type="button" value="取り消す">
                </span>
            </div>
        </div>

        <hr>
    </div>

    <!-- window for confirmation of submit -->
    <div id="modal-control-confirm-entry"></div>
    <div id="divConfirmSubmit" style="display:none">
        <div style="padding: 20px">
            <span>
                登録しますか？
                <input id="button-no-confirm-entry" type="button" value="いいえ">
                <input id="button-yes-confirm-entry" type="button" value="はい">
            </span>
            <hr>
            <div id="divConfirmEntry"></div>
        </div>
    </div>

</div>
</body>
</html>

