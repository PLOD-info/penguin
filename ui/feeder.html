<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>PLOD Entry Form</title>
    <!--<script type="text/javascript" src="template.js"></script>-->

    <!--script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script-->

    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet">
    <link href="select2-to-tree/src/select2totree.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
    <script src="select2-to-tree/src/select2totree.js"></script>
    <script src="lglist-select2-20200327.js"></script>

    <link rel="stylesheet" href="datetimepicker/jquery.datetimepicker.css">
    <!--script type="text/javascript" src="datetimepicker/jquery-1.10.2.min.js"></script-->
    <script type="text/javascript" src="datetimepicker/build/jquery.datetimepicker.full.min.js"></script>

    <script type="text/javascript">

var SERVER_PATH = '';
var DEBUG_XHR = false;

jQuery.datetimepicker.setLocale("ja");

/*
 * NOTE: if you change the value of the lists.
 * you have to check value_selected in below functions.
 *     add_input_select_to_obj()
 *     add_input_select_freetext_to_obj()
 *     add_input_select_options_to_obj()
 */

/* publisher */
let publisherList = []; // produced from lgList.

/* location */
let locationList = [];  // copied from lgList at this time.

/* age */
const ageList = [
    { "key":"0-9",  "value":"0s" },
    { "key":"10代", "value":"10s" },
    { "key":"20代", "value":"20s" },
    { "key":"30代", "value":"30s" },
    { "key":"40代", "value":"40s" },
    { "key":"50代", "value":"50s" },
    { "key":"60代", "value":"60s" },
    { "key":"70代", "value":"70s" },
    { "key":"80代", "value":"80s" },
    { "key":"90代", "value":"90s" },
    { "key":"非公開", "value":"Unspecified" },
];

/* gender */
const genderList = [
    { "key":"男性", "value":"Male" },
    { "key":"女性", "value":"Female" },
    { "key":"非公開", "value":"Unspecified" },
];

/* disease */
const diseaseList = [
    { "key":"新型コロナウイルス", "value":"COVID-2019" },
    { "key":"麻疹", "value":"Measles" },
    { "key":"未確定", "value":"Unconfirmed" },
];

/* patientCondition + name */
const patientConditionList = [
    { "key": "倦怠感", "name": "Malaise" },
    { "key": "喀痰", "name": "Sputum" },
    { "key": "発熱", "name": "Fever" },
    { "key": "悪寒", "name": "Chill" },
    { "key": "咳", "name": "Cough" },
    { "key": "鼻水", "name": "Cough" },
    { "key": "肺炎", "name": "Pneumonia" },
    { "key": "入院", "name": "Hospitalized" },
    { "key": "陽性", "name": "Positive" },
];

/* transportationMethod + name */
const transportationMethodList = [
    { "key": "タクシー", "name": "Taxi" },
    { "key": "バス", "name": "Bus" },
    { "key": "電車", "name": "Train" },
    { "key": "飛行機", "name": "yAirplane" },
    { "key": "船", "name": "Ship" },
    { "key": "徒歩", "name": "yWalk" },
    { "key": "不明", "name": "Unknown" },
    // any vehicles that you can drive solely are not in case.
    // { "key": "自家用車・自転車・バイク", "name": "Bike" },
]

window.addEventListener("load", ev_load, false);

let row_num = 0;

function debug_table(table)
{
    console.log("xxx === debug_table() ===");
    for (var r = 0, n = table.rows.length; r < n; r++) {
        for (var c = 0, m = table.rows[r].cells.length; c < m; c++) {
            console.log("xxx cell():", r, c, table.rows[r].cells[c]);
        }
    }
}

function get_row_num()
{
    // no purpose than making a cell to be unique. 
    row_num += 1;
    return row_num;
}

function add_input_checkbox_freetext_to_obj(parent_obj, target_name, item_list, placeholder_text)
{
    /*
     * add target_name + name as the name of the checkboxes.
     * don't use id to identify a checkbox.
     */
    let div_obj, x;

    item_list.forEach(kv => {
        div_obj = document.createElement("div")
        div_obj.classList.add(target_name + "Checkbox");

        x = document.createElement("input");
        x.type = "checkbox";
        //x.name = target_name+kv["name"];
        x.name = kv["name"];
        div_obj.appendChild(x);

        x = document.createElement("label")
        x.htmlFor = target_name+kv["name"]
        x.appendChild(document.createTextNode(kv["key"]));
        div_obj.appendChild(x);

        parent_obj.appendChild(div_obj);
    });

    div_obj = document.createElement("div");
    div_obj.classList.add("FreeTextBoxByCheckbox");
    x = document.createElement("textarea");
    x.name = target_name + "FreeText"
    if (placeholder_text != undefined) {
        x.placeholder = placeholder_text;
    } else {
        x.placeholder = "備考等自由記述";
    }
    x.classList.add(target_name + "FreeText");
    div_obj.appendChild(x);

    parent_obj.appendChild(div_obj);
}

function add_input_select_options_to_obj(parent_obj, opts, value_selected)
{
    /*
     * parent_obj, not parent_id, should be passed here.
     * because the parent_id is not listed in the document level list.
     */
    opts.forEach(x => {
        let opt = document.createElement("option");
        opt.text = x["key"];
        opt.value = x["value"];
        if (value_selected != null && x["value"] == value_selected) {
            opt.selected = true;
        }
        parent_obj.add(opt, null);
    });
}

function add_input_select_to_obj(parent_obj, target_id, select_list, value_selected)
{
    let x, x2;

    x = document.createElement("div");
    x2 = document.createElement("select");
    x2.id = target_id + "Selected";
    add_input_select_options_to_obj(x2, select_list, value_selected);
    x.appendChild(x2);

    parent_obj.appendChild(x);
}

function add_input_select2_freetext_to_obj(parent_obj, target_id, select_list_given, value_selected, placeholder_text, label_name)
{
    let x, x2, x3;

    x = document.createElement("div");
    x.classList.add("classDivSelectFreeText");
    if (label_name != undefined) {
        x2 = document.createElement("label");
        x2.htmlFor = target_id + "Selected";
        x2.innerHTML = label_name;
        x.appendChild(x2);
    }
    x2 = document.createElement("select");
    x2.id = target_id + "Selected";
    x.appendChild(x2);
    jQuery(x2).select2ToTree({
        treeData: {dataArr: select_list_given.concat({ "id": "Others", "text": "その他" })},
        multiple: false,
        dropdownAutoWidth: "auto",
        width: "auto",
    }).val(value_selected).trigger("change");
    /* if value_selected doesn't apper, you should check if the value exists in the select_list_given. */

    x2 = document.createElement("div");
    x2.id = target_id + "FreeTextBlock";
    x3 = document.createElement("input");
    x3.type = "text";
    x3.id = target_id + "FreeText";
    if (placeholder_text != undefined) {
        x3.placeholder = "補足情報等があれば入力する。";
    } else {
        x3.placeholder = "選択肢にない場合、その他を選んでから記述する。";
    }
    x2.appendChild(x3);
    x.appendChild(x2);

    parent_obj.appendChild(x);
}

function add_input_select_freetext_to_obj(parent_obj, target_id, select_list, value_selected)
{
    let x, x2, x3;

    x = document.createElement("div");
    x.classList.add("classDivSelectFreeText");
    x2 = document.createElement("label");
    x2.htmlFor = target_id + "Selected";
    x.appendChild(x2);
    x2 = document.createElement("select");
    x2.id = target_id + "Selected";
    add_input_select_options_to_obj(x2, select_list.concat({ "key":"その他", "value":"Others" }), value_selected);
    x.appendChild(x2);

    x2 = document.createElement("div");
    //x2.classList.add(target_id + "FreeTextBlock");
    x2.id = target_id + "FreeTextBlock";
    x3 = document.createElement("input");
    x3.type = "text";
    x3.id = target_id + "FreeText";
    x3.placeholder = "選択肢にない場合、その他を選んでから記述する。";
    x2.appendChild(x3);
    x.appendChild(x2);

    parent_obj.appendChild(x);
}

function get_current_date()
{
    let local_time = new Date();
    return local_time.toJSON().slice(0,10);
}

function add_input_date_to_obj(parent_obj, target_id)
{
    let x = document.createElement("input");
    x.type = "text";
    x.id = target_id;
    x.classList.add("inputDate");
    parent_obj.appendChild(x);
    jQuery(`#${x.id}`).val(get_current_date());
    jQuery(`#${x.id}`).datetimepicker({
        timepicker: false,
        format: "Y-m-d",
        scrollMonth : false,    // disable scroll in both.
        //scrollInput : false,    // disable scroll in the text field.
    });
}

function add_input_time_to_obj(parent_obj, target_id)
{
    let local_time = new Date();
    let x = document.createElement("input");
    x.type = "text";
    x.id = target_id;
    x.placeholder = "可能ならば時刻を入力する。";
    x.classList.add("inputTime");
    parent_obj.appendChild(x);
    jQuery(`#${x.id}`).datetimepicker({
        datepicker: false,
        format: "H:i",
        step: 30,
        defaultTime: "12:00",
    });
}

function add_input_date_time_to_obj(parent_obj, target_date_id, target_time_id, line_break)
{
    add_input_date_to_obj(parent_obj, target_date_id);
    if (target_time_id != null) {
        if (line_break == true) {
            parent_obj.appendChild(document.createElement("br"));
        }
        add_input_time_to_obj(parent_obj, target_time_id);
    }
}

function add_input_text_to_obj(parent_obj, target_id, placeholder_text)
{
    let x = document.createElement("input");
    x.id = target_id;
    x.type = "text";
    if (placeholder_text != undefined) {
        x.placeholder = placeholder_text;
    } else {
        x.placeholder = "備考等自由記述";
    }
    parent_obj.appendChild(x);
}

function add_input_textarea_to_obj(parent_obj, target_id, placeholder_text)
{
    let x = document.createElement("textarea");
    x.id = target_id;
    if (placeholder_text != undefined) {
        x.placeholder = placeholder_text;
    } else {
        x.placeholder = "備考等自由記述";
    }
    parent_obj.appendChild(x);
}

function add_input_ins_line_to_obj(parent_obj, row)
{
    let x = document.createElement("input");
    x.class = "inputInsLine"
    x.type="button";
    x.value = "↑追加";
    x.addEventListener("click", function(){ ev_click_ins_line(row) }, false);
    parent_obj.appendChild(x);
}

function add_input_del_line_to_obj(parent_obj, row)
{
    let x = document.createElement("input");
    x.class = "inputDelLine"
    x.type="button";
    x.value = "←削除";
    x.addEventListener("click", function(){ ev_click_del_line(row) }, false);
    parent_obj.appendChild(x);
}

function ins_line_patient_location_history(row_index_ins)
{
    let table = document.getElementById("tablePatientLocationHistory");
    let row = table.insertRow(row_index_ins);
    let row_index = table.rows.length;
    let row_num = get_row_num();
    let x, x2, x3, cell;

    /* "出発時間",
        patientLocationHistoryDepartureDate, date
        patientLocationHistoryDepartureTime, time
     */
    cell = row.insertCell(-1);
    add_input_date_time_to_obj(cell, "patientLocationHistoryDepartureDate" + row_num, "patientLocationHistoryDepartureTime" + row_num, true);

    /* "出発地", patientLocationHistoryDepartureFrom, select+text */
    cell = row.insertCell(-1);
    add_input_select2_freetext_to_obj(cell, "patientLocationHistoryDepartureFrom" + row_num, locationList, "東京都", "補足情報等があれば入力する。");

    /* "到着時間", patientLocationHistoryArrivalDateTime, date+time */
    cell = row.insertCell(-1);
    add_input_date_time_to_obj(cell, "patientLocationHistoryArrivalDate" + row_num, "patientLocationHistoryArrivalTime" + row_num, true);

    /* "到着地", patientLocationHistoryArrivalIn, select+text */
    cell = row.insertCell(-1);
    add_input_select2_freetext_to_obj(cell, "patientLocationHistoryArrivalIn" + row_num, locationList, "東京都", "補足情報等があれば入力する。");

    /* "移動手段", transportationMethod, select+text */
    cell = row.insertCell(-1);
    add_input_checkbox_freetext_to_obj(cell, "transportationMethod", transportationMethodList, "自由記述\n(自家用車、バイク等他人と遭遇せず単独行動した場合等)");

    /* "所見や患者の行動、その他", patientLocationHistoryDetail, text */
    cell = row.insertCell(-1);
    add_input_textarea_to_obj(cell, "patientLocationHistoryDetail" + row_num);

    /* DelLine */
    cell = row.insertCell(-1);
    add_input_ins_line_to_obj(cell, row);
    cell.appendChild(document.createElement("br"));
    add_input_del_line_to_obj(cell, row);
}

function ins_line_patient_condition_history(row_index_ins)
{
    let table = document.getElementById("tablePatientConditionHistory");
    let row = table.insertRow(row_index_ins);
    let row_index = table.rows.length;
    let row_num = get_row_num();
    let x, x2, x3, cell;

    /*
     "日付", cellPatientConditionHistoryDateTime, date+time
        patientConditionHistoryDate, date
        patientConditionHistoryTime, time
    */
    cell = row.insertCell(-1);
    add_input_date_time_to_obj(cell, "patientConditionHistoryDate" + row_num, "patientConditionHistoryTime" + row_num, true);

    /* "健康状態", patientConditionHistoryStatus, checkbox+text */
    cell = row.insertCell(-1);
    add_input_checkbox_freetext_to_obj(cell, "patientConditionHistoryStatus", patientConditionList);

    /* "所見や患者の行動、その他", patientConditionHistoryDetail, text */
    cell = row.insertCell(-1);
    add_input_textarea_to_obj(cell, "patientConditionHistoryDetail" + row_num);

    /* DelLine */
    cell = row.insertCell(-1);
    add_input_ins_line_to_obj(cell, row);
    cell.appendChild(document.createElement("br"));
    add_input_del_line_to_obj(cell, row);
}

/*
 * functions for submission
 */
/* XXX delete post_request() when you confirm whether this program can work on a cell phone */
/*
function post_request(url, callback, request)
{
    let xhr = new XMLHttpRequest();

    if (DEBUG_XHR === false) {
        xhr.open('POST', url, true);
        xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
    } else {
        m = 'UNSENT:' + xhr.readyState; // readyState will be 0
        console.log(m);

        xhr.open('POST', url, true);

        m = 'OPENED:' + xhr.readyState; // readyState will be 1
        console.log(m);

        xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');

        xhr.onprogress = function () {
            m = 'LOADING:' + xhr.readyState; // readyState will be 3
            console.log(m);
        }

        xhr.onload = function () {
            m = 'DONE' + xhr.readyState; // readyState will be 4
            console.log(m);
            console.log('this=', this);
            console.log('load:', JSON.parse(xhr.responseText));
        }
    }

    xhr.onreadystatechange = function() {
        console.log('xhr state:', xhr.readyState);
        if (xhr.readyState === 4) {
            callback(xhr.status == 200 ? JSON.parse(xhr.responseText) : null);
        }
    }

    xhr.send(JSON.stringify(request));
}
*/

function get_selected_value(target_id)
{
    //console.log("get_selected_value=", target_id);
    let x = document.getElementById(target_id);
    let selected_value = x.options[x.selectedIndex].value;
    if (selected_value != "") {
        return selected_value;
    } else {
        return undefined;
    }
}

function get_one_element_by_regex(parent_obj, target_regex)
{
    let x, a;

    if (parent_obj.id && parent_obj.id.match(target_regex)) {
        //console.log("==> match", parent_obj.id);
        return parent_obj;
    }

    if (parent_obj.children == undefined) {
        return undefined;
    }

    /* first, walk this level. */
    for (let i = 0; i < parent_obj.childNodes.length; i++) {
        x = parent_obj.childNodes[i];
        //console.log("==> xxx by_regex:", i, x.id, target_regex, x);
        a = get_one_element_by_regex(x, target_regex);
        if (a != undefined) {
            return a;
        }
    }

    return undefined;
}

function get_elements_by_regex(parent_obj, target_regex)
{
    let x, a;

    if (parent_obj.id && parent_obj.id.match(target_regex)) {
        //console.log("==> match", parent_obj.id);
        return [parent_obj];
    }

    if (parent_obj.children == undefined) {
        return undefined;
    }

    /* first, walk this level. */
    let result = [];
    for (let i = 0; i < parent_obj.childNodes.length; i++) {
        x = parent_obj.childNodes[i];
        //console.log("==> xxx by_regex:", i, x.id, target_regex, x);
        a = get_elements_by_regex(x, target_regex);
        if (a != undefined) {
            result = result.concat(a);
        }
    }

    if (result.length == 0) {
        return undefined;
    } else {
        return result;
    }
}

function get_one_value(target_id, a, b)
{
    if (b == "" || b == undefined) {
        return a;
    } else {
        if (a != "Others") {
            window.alert(target_id + `: ${a} が選択され、かつ、その他のフィールドに ${b} が入っています。${a} が採用されました。`);
            return a;
        }
        return b;
    }
}

function get_value_select_freetext_in_obj(parent_obj, target_id)
{
    let ax = get_one_element_by_regex(parent_obj, new RegExp(`${target_id}\\d+Selected$`));
    let a = ax.options[ax.selectedIndex].value;
    let bx = get_one_element_by_regex(parent_obj, new RegExp(`${target_id}\\d+FreeText$`));
    let b = bx.value;
    return get_one_value(target_id, a, b);
}

function get_value_select_freetext(target_id)
{
    let a = get_selected_value(target_id + "Selected");
    let b = document.getElementById(target_id + "FreeText").value;
    return get_one_value(target_id, a, b);
}

function make_patient_data()
{
    let created_data = {
        "publisher": get_value_select_freetext("publisher"),
        "localId": jQuery("#localId").val(),
        "localSubId": jQuery("#localSubId").val(),
        "disease": get_value_select_freetext("patientDisease"),
        "dateConfirmed": jQuery("#dateConfirmed").val(),
        "age": get_selected_value("patientAgeSelected"),
        "gender": get_selected_value("patientGenderSelected"),
        "residence": jQuery("#patientResidenceSelected").val(),
        "residenceAnnex": jQuery("#patientResidenceFreeText").val(),
        "locationHistory": [
        ],
        "conditionHistory": [
        ]
    };
    let table;

    table = document.getElementById("tablePatientLocationHistory");
    //debug_table(table);

    for (let i = 1; i < table.rows.length; i++) {
        //console.log("xxx PLH table:", i, table.rows[i]);
        let kv = {};
        let row = table.rows[i];
        kv["departureDate"] = get_one_element_by_regex(row.cells[0], new RegExp("patientLocationHistoryDepartureDate\\d+$")).value;
        kv["departureTime"] = get_one_element_by_regex(row.cells[0], new RegExp("patientLocationHistoryDepartureTime\\d+$")).value;
        kv["departureFrom"] = get_one_element_by_regex(row.cells[1], new RegExp("patientLocationHistoryDepartureFrom\\d+Selected$")).value;
        kv["departureFromAnnex"] = get_one_element_by_regex(row.cells[1], new RegExp("patientLocationHistoryDepartureFrom\\d+FreeText$")).value;
        kv["arrivalDate"] = get_one_element_by_regex(row.cells[2], new RegExp("patientLocationHistoryArrivalDate\\d+$")).value;
        kv["arrivalTime"] = get_one_element_by_regex(row.cells[2], new RegExp("patientLocationHistoryArrivalTime\\d+$")).value;
        kv["arrivalIn"] = get_one_element_by_regex(row.cells[3], new RegExp("patientLocationHistoryArrivalIn\\d+Selected$")).value;
        kv["arrivalInAnnex"] = get_one_element_by_regex(row.cells[3], new RegExp("patientLocationHistoryArrivalIn\\d+FreeText$")).value;
        kv["vehicles"] = [];
        row.cells[4].childNodes.forEach(x => { // transportationMethod
            x.childNodes.forEach(y => {
                if (y.type == "checkbox" && y.checked == true) {
                    kv["vehicles"].push(y.name);
                }
                if (y.type == "textarea" && y.value.length > 0) {
                    kv["vehicleOthers"] = y.value;
                }
            });
        });
        kv["details"] = get_one_element_by_regex(row.cells[5], new RegExp("patientLocationHistoryDetail\\d+$")).value;
        created_data["locationHistory"].push(kv);
    }

    table = document.getElementById("tablePatientConditionHistory");
    //debug_table(table);

    for (let i = 1; i < table.rows.length; i++) {
        //console.log("xxx PCH table:", i, table.rows[i]);
        let kv = {};
        let row = table.rows[i];
        kv["recordDate"] = get_one_element_by_regex(row.cells[0], new RegExp("patientConditionHistoryDate\\d+$")).value;
        kv["recordTime"] = get_one_element_by_regex(row.cells[0], new RegExp("patientConditionHistoryTime\\d+$")).value;
        kv["conditions"] = [];
        row.cells[1].childNodes.forEach(x => { // patientConditionHistoryStatus
            x.childNodes.forEach(y => {
                if (y.type == "checkbox" && y.checked == true) {
                    kv["conditions"].push(y.name);
                }
                if (y.type == "textarea" && y.value.length > 0) {
                    kv["conditionOthers"] = y.value;
                }
            });
        });
        kv["details"] = get_one_element_by_regex(row.cells[2], new RegExp("patientConditionHistoryDetail\\d+$")).value;
        created_data["conditionHistory"].push(kv);
    }

    console.log("created_data=", created_data);
    return created_data;
}

async function send_patient_data(patient_data)
{
    fetch(SERVER_PATH + "/beak", {
        method: "POST",
        headers: { "Content-Type": "application/json; charset=utf-8" },
        body: JSON.stringify(patient_data),
    }).then(response => {
        console.log("response:", response);
        return response.json();
    }).then(content => {
        confirm("EventID " + content["result"]["reportId"] + " で、登録されました。");
        window.location.reload(false);
    }).catch(error => console.error("Error:", error));
    /*
    $.ajax({
        url: SERVER_PATH + "/beak",
        type: "POST",
        dataType: "text",
        data: JSON.stringify(patient_data)
    }).done(function(content) {
        console.log("callback=", content);
        if (content) {
            content = JSON.parse(content);
            confirm("EventID " + content["result"]["reportId"] + " で、登録されました。");
            //put_current_value(content);
        }
    });
    */
    /*
    if (Object.keys(patient_data).length != 0) {
        // post only if any value are changed.
        post_request(SERVER_PATH + '/beak', function(content) {
                console.log("callback=", content);
                if (content) {
                    confirm("EventID " + content["result"]["reportId"] +
                        " で、登録されました。");
                    //put_current_value(content);
                }
            },
            patient_data);
    }
    */
}

/*
 * event handlers
 */
function ev_click_ins_line_patient_location_history()
{
    ins_line_patient_location_history(-1);
}

function ev_click_ins_line_patient_condition_history()
{
    ins_line_patient_condition_history(-1);
}

function ev_click_ins_line(row)
{
    if (row.parentElement.parentElement.id == "tablePatientLocationHistory") {
        ins_line_patient_location_history(row.rowIndex);
    } else
    if (row.parentElement.parentElement.id == "tablePatientConditionHistory") {
        ins_line_patient_condition_history(row.rowIndex);
    }
}

function ev_click_del_line(row)
{
    if (true == confirm("削除しますか？")) {
        jQuery(get_elements_by_regex(row, new RegExp("Date\\d+$"))).datetimepicker("destroy");
        jQuery(get_elements_by_regex(row, new RegExp("Time\\d+$"))).datetimepicker("destroy");
        row.parentNode.deleteRow(row.sectionRowIndex);
    }
}

function ev_click_submit(a)
{
    if (true == confirm("登録しますか？")) {
        send_patient_data(make_patient_data());
    }
}

function ev_click_confirm_no()
{
    jQuery(".divModelBlock").fadeOut();
}

function ev_click_confirm_yes()
{
    jQuery(".divModelBlock").fadeOut();
    send_patient_data(make_patient_data());
}

function ev_click_confirm(a)
{
    let created_data = make_patient_data();

    let x = document.getElementById("confirmMessage");
    x.innerText = JSON.stringify(created_data, undefined, 2);

    jQuery(".divModelBlock").fadeIn();
}

function ev_load(e)
{
    let parent_obj;


    /* create other list bsaed from lgList. */
    //lgList.forEach(x => {
    //    publisherList.push({ "id": x["id"], "text": x["text"] });
    //});
    publisherList = JSON.parse(JSON.stringify(lgList));
    publisherList.unshift({ "id": "厚労省", "text": "厚労省" });
    locationList = JSON.parse(JSON.stringify(lgList));
    //locationList.push({ "id": "Others", "text": "その他" });

    /* layout the blocks */
    add_input_select2_freetext_to_obj(document.getElementById("divBlockPublisher"), "publisher", publisherList, "厚労省", undefined, "所轄の自治体名:");
    add_input_text_to_obj(document.getElementById("divLocalId"), "localId", "厚労省で管理している識別子等あれば入力する。");
    add_input_text_to_obj(document.getElementById("divLocalSubId"), "localSubId", "所轄における識別子等あれば入力する。");
    add_input_text_to_obj(document.getElementById("divKeywords"), "keywords", "自由記述");

    add_input_date_to_obj(document.getElementById("divBlockDateConfirmed"), "dateConfirmed");

    add_input_select_to_obj(document.getElementById("divPatientAge"), "patientAge", ageList, "Unspecified");

    add_input_select_to_obj(document.getElementById("divPatientGender"), "patientGender", genderList, "Unspecified");

    add_input_select_freetext_to_obj(document.getElementById("divBlockPatientDisease"), "patientDisease", diseaseList, "COVID-2019");

    add_input_select2_freetext_to_obj(document.getElementById("divBlockPatientResidence"), "patientResidence", lgList, "東京都", "補足情報等があれば入力する。", "患者の居住地域:");

    /* create patient's location history */
    document.getElementById("addLinePatientLocationHistory").addEventListener("click", ev_click_ins_line_patient_location_history, false);
    ins_line_patient_location_history(-1);

    /* create patient's condition history */
    document.getElementById("addLinePatientConditionHistory").addEventListener("click", ev_click_ins_line_patient_condition_history, false);
    ins_line_patient_condition_history(-1);

    document.getElementById("confirmButton").addEventListener("click", ev_click_confirm, false);
    document.getElementById("submitButton").addEventListener("click", ev_click_submit, false);

    /* modal window for confirming */
    document.getElementById("confirmButtonYes").addEventListener("click", ev_click_confirm_yes, false);
    jQuery(".confirmButtonNo").on("click", ev_click_confirm_no);

}

    </script>

    <!-- link rel="stylesheet" type="text/css" href="feeder.css" -->
    <style type="text/css">

    * { font-size: 14px; }
    .inputDate, .inputTime { width: 100px; }
    .transportationMethodCheckbox { display: inline-block; }
    .transportationMethodFreeText { width: 340px; }
    .patientConditionHistoryStatusCheckbox { display: inline-block; margin-right:8px; }
    .patientConditionHistoryStatusFreeText { width: 95%; }
    /*textarea[id^="patientLocationHistoryDetail"]  { width: 500px; }*/
    input[id^="patientLocationHistoryDepartureFrom"] { width: 180px; }
    input[id^="patientLocationHistoryArrivalIn"] { width: 180px; }
    /*textarea[id^="patientConditionHistoryDetail2"]  { width: 500px; }*/

    /* below are for alignment of the blocks. */
    .divBlock { display: inline-block; padding: 5px; margin-bottom: 5px; border: 1px dotted #333333; }

    .inputInsLine { }
    .inputDelLine { }
    .classDivSelectFreeText { display: inline-block; }
    .cellBlock { margin-left: 3px; }

    #divBlockPublisher, #divBlockLocalId, #divBlockLocalSubId, #divBlockKeywords, #divBlockPatientDisease, #divBlockDateConfirmed, #divBlockPatientAge, #divBlockPatientGender, #divBlockPatientResidence, #divPatientResidence { display: inline-block; padding: 5px; border: 1px dotted #333333; }

    #divPublisher, #publisherSelected, #publisherFreeTextBlock,
    #divLocalId,
    #divLocalSubId,
    #divKeywords,
    #divPatientDisease, #patientDiseaseSelected, #patientDiseaseFreeTextBlock,
    #divDateConfirmed, #dateConfirmed,
    #divPatientAge, #patientAgeSelected,
    #divPatientGender, #patientGenderSelected,
    #divPatientResidence, #patientResidenceSelected, #patientResidenceFreeTextBlock { display: inline-block; }

    #plodLogo { float:left; margin-right: 10px; }

    /* below are for the placeholder */
    input::-webkit-input-placeholder { font-size: 8px; }
    input:-moz-placeholder { font-size: 8px; }
    input::-moz-placeholder { font-size: 8px; }
    input:-ms-input-placeholder { font-size: 8px; }
    textarea::placeholder { font-size: 8px; }

    /* below are for the modal block */
    .divModelBlock {
        display: none;
        height: 100vh;
        position: fixed;
        top: 0;
        width: 100%;
    }
    .divModalContainer {
        background: rgba(0,0,0,0.8);
        height: 100vh;
        position: absolute;
        width: 100%;
    }
    #divModalContent {
        background: #fff;
        left: 50%;
        padding: 40px;
        position: absolute;
        top: 50%;
        transform: translate(-50%,-50%);
        width: 60%;
        height: 80%;
        overflow: auto;
    }
    #confirmMessage {
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 18px;
    }

    </style>

</head>
<body>

    <div>
        <div style="display:inline-block">
            <a href="image/PLOD-v0.1.png">
                <img id="plodLogo" src="image/PLOD-v0.1-48x48.png" alt="PLOD logo">
            </a>
        </div>
        <div style="display:inline-block; width:60%;">
            <span>Patient Locational Open Data (PLOD) Entry Form</span>
            <br>
            <span>注意事項的な記述がここに入る想定</span>
        </div>
        <!--
        <div style="display:inline-block; float:right;">
            <a href="http://127.0.0.1:8081">編集(臨時)</a>
        </div>
        -->
    </div>
    <hr>

    <div class="divBlock">
        <div id="divBlockPublisher">
            <!--label for="divPublisher">所轄の自治体名:</label-->
            <!-- insert dynamically -->
        </div>
        <div id="divBlockLocalId">
            <label for="divLocalId">管理No:</label>
            <div id="divLocalId"></div>
            <!-- insert dynamically -->
        </div>
        <div id="divBlockLocalSubId">
            <label for="divLocalSubId">副管理No:</label>
            <div id="divLocalSubId"></div>
            <!-- insert dynamically -->
        </div>
        <div id="divBlockKeywords">
            <label for="divKeywords">Keywords:</label>
            <div id="divKeywords"></div>
            <!-- insert dynamically -->
        </div>
    </div>

    <div class="divBlock">
        <div id="divBlockPatientDisease">
            <label for="divPatientDisease">患者の病名:</label>
            <!-- insert dynamically -->
        </div>

        <div id="divBlockDateConfirmed">
            <label for="dateConfirmed">患者の状態が確認された日付:</label>
            <!--input id="dateConfirmed" type="text" /-->
            <!-- insert dynamically -->
        </div>
    </div>

    <div class="divBlock">
        <div id="divBlockPatientAge">
            <label for="divPatientAge">患者の年代:</label>
            <div id="divPatientAge"></div>
            <!-- insert dynamically -->
        </div>

        <div id="divBlockPatientGender">
            <label for="divPatientGender">患者の性別:</label>
            <div id="divPatientGender"></div>
            <!-- insert dynamically -->
        </div>

        <div id="divBlockPatientResidence">
            <!--label for="divPatientResidence">患者の居住地域:</label-->
            <!-- insert dynamically -->
        </div>
    </div>

    <hr>
    <div class="divBlock" id="divPatientLocationHistoryBlock">
        <label for="divPatientLocationHistory">患者の移動の履歴:</label>
        <div id="divPatientLocationHistory">
            <table id="tablePatientLocationHistory" border=1>
                <tr>
                    <th class="trPatientLocationHistoryDepartureDateTime">出発時間</th>
                    <th class="trPatientLocationHistoryDepartureFrom">出発地</th>
                    <th class="trPatientLocationHistoryDepartureDateTime">到着時間</th>
                    <th class="trPatientLocationHistoryArrivalIn">到着地</th>
                    <th class="trTransportationMethod">手段</th>
                    <th class="trPatientLocationHistoryDetail">所見や患者の行動、その他</th>
                    <th>行増減</th>
                </tr>
                <!-- insert dynamically -->
            </table>
            <input id="addLinePatientLocationHistory" type="button" value="↑行を追加する">
        </div>
    </div>

    <hr>
    <div class="divBlock" id="divPatientConditionHistoryBlock">
        <label for="divPatientConditionHistory">患者の状態の履歴:</label>
        <div id="divPatientConditionHistory">
            <table id="tablePatientConditionHistory" border=1>
                <tr>
                    <th>日付</th>
                    <th>健康状態</th>
                    <th>所見や状況、その他</th>
                    <th>行増減</th>
                </tr>
                <!-- insert dynamically -->
            </table>
            <input id="addLinePatientConditionHistory" type="button" value="↑行を追加する">
        </div>
    </div>

    <div>
        <input id="confirmButton" type="button" value="確認画面へ移動する。">
        <input id="submitButton" type="button" value="登録する。">
    </div>

    <hr>

    <div class="divModelBlock">
        <div class="divModalContainer confirmButtonNo"></div>
        <div id="divModalContent">
            <div>
                登録しますか？
                <input class="confirmButtonNo" type="button" value="いいえ">
                <input id="confirmButtonYes" type="button" value="はい">
            </div>
            <hr>
            <div id="confirmMessage"></div>
        </div>
    </div>

</body>
</html>


